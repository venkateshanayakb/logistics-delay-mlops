# ── Backend CI — Lint & Test ────────────────────────────────────
# Triggers on push/PR to main that touch backend or ML code.

name: Backend CI

on:
    push:
        branches: [main]
        paths:
            - "api/**"
            - "src/**"
            - "tests/**"
            - "requirements*.txt"
    pull_request:
        branches: [main]
        paths:
            - "api/**"
            - "src/**"
            - "tests/**"
            - "requirements*.txt"

jobs:
    lint-and-test:
        runs-on: ubuntu-latest
        strategy:
            matrix:
                python-version: ["3.11"]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}

            - name: Cache pip packages
              uses: actions/cache@v4
              with:
                  path: ~/.cache/pip
                  key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
                  restore-keys: |
                      ${{ runner.os }}-pip-

            - name: Install dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install -r requirements.txt
                  pip install pytest pytest-cov httpx

            - name: Lint with flake8
              run: |
                  echo "── Critical errors (stop the build) ──"
                  flake8 api/ src/ tests/ --count --select=E9,F63,F7,F82 --show-source --statistics
                  echo "── Warnings (non-blocking) ──"
                  flake8 api/ src/ tests/ --count --exit-zero --statistics

            - name: Run tests with pytest
              env:
                  MODEL_PATH: "models/best_pipeline.joblib"
              run: |
                  pytest tests/ -v --tb=short --cov=api --cov=src --cov-report=term-missing
